<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Dashboard - SMART SYSTEM V27.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a5276; --bg: #f4f7f6; --white: #ffffff; --green: #27ae60; --text: #2c3e50; --gold: #f1c40f; --red: #e74c3c; --border: #ddd; --loader-bg: #9CBCE3; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-tap-highlight-color: transparent; }

        /* üé® Loader */
        #loader-container { position: fixed; inset: 0; background: var(--loader-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease; }
        .emoji-group { display: flex; gap: 15px; margin-bottom: 25px; font-size: 60px; }
        .bounce { animation: bounce 0.6s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        .loader-text { color: white; font-weight: 900; font-size: 1.6rem; letter-spacing: 1px; text-transform: uppercase; text-align: center; }

        /* üö© Header */
        header { background: #fff; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .brand-name { font-weight: 500; font-size: 0.85rem; color: var(--primary); text-transform: uppercase; border-left: 1.5px solid #eee; padding-left: 10px; }
        .logout-btn { color: var(--red); font-size: 0.8rem; font-weight: 600; cursor: pointer; text-transform: uppercase; }

        /* üîê Login Box */
        .login-container { display: flex; align-items: center; justify-content: center; padding: 40px 20px; min-height: 80vh; }
        .login-card { background: #fff; width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: center; }
        .login-icon { width: 70px; height: 70px; background: var(--bg); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 25px; color: var(--primary); font-size: 1.8rem; }
        .input-field { width: 100%; padding: 15px; border-radius: 50px; border: 1.5px solid var(--border); box-sizing: border-box; font-family: 'Kanit'; text-align: center; margin-bottom: 20px; outline: none; }
        .btn-primary { width: 100%; padding: 15px; border-radius: 50px; border: none; background: var(--primary); color: white; font-family: 'Kanit'; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(26,82,118,0.2); }

        /* üìä Dashboard Content (Step 2) */
        #dashboard-section { display: none; padding: 20px 15px 100px; max-width: 800px; margin: 0 auto; }
        .welcome-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 0 10px; }
        .agent-name { font-weight: 600; color: var(--primary); font-size: 1.2rem; }
        
        .add-new-btn { background: var(--green); color: white; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(39,174,96,0.2); }

        .property-item { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #f0f0f0; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .prop-info { display: flex; flex-direction: column; gap: 4px; }
        .prop-id { font-weight: 700; color: var(--primary); font-size: 1rem; }
        .prop-project { font-size: 0.85rem; color: #777; }
        .prop-price { font-size: 0.9rem; color: var(--text); font-weight: 500; }
        
        .edit-btn { background: var(--bg); color: var(--primary); width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .edit-btn:hover { background: var(--primary); color: #fff; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .available { background: var(--green); } .pending { background: var(--gold); } .sold { background: var(--red); }
    </style>
</head>
<body>

<div id="loader-container">
    <div class="emoji-group"><span class="bounce">üêö</span><span class="bounce" style="animation-delay:0.2s">üåä</span><span class="bounce" style="animation-delay:0.4s">üå¥</span></div>
    <div class="loader-text">SMART PROPERTIES SYSTEM</div>
</div>

<header>
    <div class="header-left" onclick="location.href='index.html'">
        <i class="fas fa-chevron-left" style="color:var(--primary);"></i>
        <div class="brand-name">ADMIN PORTAL</div>
    </div>
    <div id="header-logout" class="logout-btn" style="display:none;" onclick="logout()">Logout <i class="fas fa-sign-out-alt"></i></div>
</header>

<div id="login-section" class="login-container">
    <div class="login-card">
        <div class="login-icon"><i class="fas fa-user-shield"></i></div>
        <h2>Agent Login</h2>
        <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</p>
        <input type="password" id="accessKey" class="input-field" placeholder="Access Key" maxlength="20">
        <button id="loginBtn" class="btn-primary" onclick="handleLogin()">ENTER DASHBOARD</button>
        <div id="error-msg" style="color:red; font-size:0.8rem; margin-top:15px; display:none;">‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
    </div>
</div>

<div id="dashboard-section">
    <div class="welcome-bar">
        <div>
            <div style="font-size:0.75rem; color:#aaa; text-transform:uppercase;">Welcome back,</div>
            <div id="display-agent-name" class="agent-name">Agent Name</div>
        </div>
        <div style="text-align:right;">
            <div id="prop-count" style="font-size:1.1rem; font-weight:700; color:var(--primary);">0</div>
            <div style="font-size:0.65rem; color:#aaa;">Properties</div>
        </div>
    </div>

    <div onclick="alert('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Å‡∏≤‡∏£')" class="add-new-btn">
        <i class="fas fa-plus-circle"></i> ADD NEW PROPERTY
    </div>

    <div id="property-list-container">
        <div style="text-align:center; padding:50px; color:#ccc;"><i class="fas fa-sync fa-spin"></i> Loading Data...</div>
    </div>
</div>

<script>
    const api = "https://script.google.com/macros/s/AKfycbwUqp_vaFNgUdyARh5WG-S3iRm_x1C4EX0tL8aw12nhKpvYVn3I7SwWmi5s-doiYGYh/exec";
    
    window.onload = () => {
        const savedToken = localStorage.getItem('admin_token');
        const savedName = localStorage.getItem('agent_name');
        
        if (savedToken && savedName) {
            showDashboard(savedName);
        }
        
        setTimeout(() => {
            const loader = document.getElementById('loader-container');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        }, 800);
    };

    async function handleLogin() {
        const key = document.getElementById('accessKey').value;
        const btn = document.getElementById('loginBtn');
        if (!key) return;

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Authenticating...';

        try {
            const response = await fetch(`${api}?action=universalLogin&key=${key}`);
            const result = await response.json();

            if (result.success) {
                localStorage.setItem('admin_token', key);
                localStorage.setItem('agent_name', result.name);
                showDashboard(result.name);
            } else {
                document.getElementById('error-msg').style.display = 'block';
                btn.disabled = false;
                btn.innerText = 'ENTER DASHBOARD';
            }
        } catch (e) {
            alert("Connection Error");
            btn.disabled = false;
            btn.innerText = 'ENTER DASHBOARD';
        }
    }

    function showDashboard(name) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        document.getElementById('header-logout').style.display = 'block';
        document.getElementById('display-agent-name').innerText = name;
        fetchProperties();
    }

    async function fetchProperties() {
        const container = document.getElementById('property-list-container');
        try {
            const response = await fetch(api);
            const data = await response.json();
            const properties = data.filter(it => it.HP_ID || it.hp_id);

            container.innerHTML = "";
            document.getElementById('prop-count').innerText = properties.length;

            properties.forEach(it => {
                const hid = it.HP_ID || it.hp_id;
                const statusClass = it.Status ? it.Status.toLowerCase() : 'available';
                
                const div = document.createElement('div');
                div.className = 'property-item';
                div.innerHTML = `
                    <div class="prop-info">
                        <div class="prop-id">${hid} | ${it.ID || '-'}</div>
                        <div class="prop-project">${it.Project_Name || 'No Project Name'}</div>
                        <div class="prop-price">
                            <span class="status-dot ${statusClass}"></span>
                            ‡∏ø${Number(it.Price || 0).toLocaleString()}
                        </div>
                    </div>
                    <div class="edit-btn" onclick="alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™ ${hid}')">
                        <i class="fas fa-pen-nib"></i>
                    </div>
                `;
                container.appendChild(div);
            });
        } catch (e) {
            container.innerHTML = "<div style='text-align:center;color:red;'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</div>";
        }
    }

    function logout() {
        localStorage.removeItem('admin_token');
        localStorage.removeItem('agent_name');
        location.reload();
    }
</script>
</body>
</html>
