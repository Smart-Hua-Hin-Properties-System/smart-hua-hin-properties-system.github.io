<script>
    const api = "https://script.google.com/macros/s/AKfycbx0ICTtHVgCCIU48VQFb-6tO9yvKgD6_oOBIN31tBYB3oHQ3h2JTS_ZIU0JyGG2O-jc/exec";
    const user = JSON.parse(localStorage.getItem('smartAdmin'));
    let allItems = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

    async function loadData() {
        const body = document.getElementById('listBody');
        try {
            const res = await fetch(`${api}?action=adminData&projectName=${encodeURIComponent(user.projectName)}&role=${user.role}`);
            allItems = await res.json();
            body.innerHTML = allItems.length ? "" : `<div style="padding:40px; text-align:center;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</div>`;
            allItems.forEach((it, index) => {
                const row = document.createElement('div');
                row.className = 'property-item';
                row.innerHTML = `
                    <div><b>${it.HP_ID} - ${it.ID}</b><br><small>‡∏ø${Number(it.Price).toLocaleString()}</small></div>
                    <button onclick="openEdit(${index})" style="background:none; border:none; color:var(--primary); cursor:pointer;">
                        <i class="fas fa-edit fa-lg"></i>
                    </button>`;
                body.appendChild(row);
            });
        } catch(e) { body.innerHTML = `<div style="padding:40px; color:red; text-align:center;">‚ùå ‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>`; }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
    function openEdit(index) {
        const it = allItems[index];
        const form = document.getElementById('propertyForm');
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
        Object.keys(it).forEach(key => {
            if(form[key]) form[key].value = it[key];
        });
        // ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™ HP_ID ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤
        form.dataset.hpid = it.HP_ID;
        document.querySelector('#addModal h3').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• " + it.HP_ID;
        openModal();
    }

    async function saveData() {
        const btn = document.getElementById('saveBtn');
        const form = document.getElementById('propertyForm');
        const data = Object.fromEntries(new FormData(form).entries());
        
        data["Project_Name"] = user.projectName;
        if (form.dataset.hpid) data["HP_ID"] = form.dataset.hpid; // ‡∏™‡πà‡∏á HP_ID ‡πÑ‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

        btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å..."; btn.disabled = true;
        try {
            const res = await fetch(`${api}?action=saveProperty&data=${encodeURIComponent(JSON.stringify(data))}`);
            const result = await res.json();
            if(result.success) {
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                delete form.dataset.hpid; // ‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                form.reset(); closeModal(); loadData();
            }
        } catch(e) { alert("‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"); }
        btn.innerText = "üöÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; btn.disabled = false;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠ "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà"
    function openAdd() {
        const form = document.getElementById('propertyForm');
        form.reset();
        delete form.dataset.hpid;
        document.querySelector('#addModal h3').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà";
        openModal();
    }
</script>
