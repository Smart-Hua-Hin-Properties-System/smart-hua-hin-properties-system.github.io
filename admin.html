<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMART ADMIN ENTERPRISE</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a5276; --bg: #f4f7f6; --green: #27ae60; --red: #e74c3c; --gold: #f1c40f; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; }
        header { background: #fff; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
        .hidden { display: none !important; }
        .card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .badge { font-size: 0.65rem; padding: 3px 10px; border-radius: 50px; color: #fff; font-weight: 600; text-transform: uppercase; }
        .role-SUPER_ADMIN { background: #000; } .role-PROJECT_ADMIN { background: var(--primary); }
        .role-OWNER { background: #8e44ad; } .role-FINANCE { background: var(--gold); } .role-AGENT { background: var(--green); }
        .btn-main { background: var(--primary); color: #fff; padding: 15px; border-radius: 50px; border: none; width: 100%; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div onclick="location.href='index.html'"><i class="fas fa-home"></i> HOME</div>
    <div id="user-display"></div>
    <div id="logout-btn" class="hidden" onclick="logout()" style="color:var(--red); font-weight:600;">LOGOUT</div>
</header>

<div id="login-box" style="padding:40px 20px; text-align:center;">
    <i class="fas fa-user-shield fa-3x" style="color:var(--primary); margin-bottom:20px;"></i>
    <h2>Portal Login</h2>
    <input type="password" id="pinInput" placeholder="Enter Access PIN" style="width:100%; max-width:300px; padding:15px; border-radius:50px; border:1px solid #ddd; text-align:center; font-size:1.2rem; outline:none; margin-bottom:20px;">
    <button class="btn-main" style="max-width:300px;" onclick="handleLogin()">ACCESS DASHBOARD</button>
</div>

<div id="main-dashboard" class="hidden" style="padding:20px;">
    <div id="finance-summary" class="hidden" style="background:var(--primary); color:#fff; padding:20px; border-radius:20px; margin-bottom:20px;">
        <small>à¸£à¸²à¸¢à¸‡à¸²à¸™à¸ à¸²à¸žà¸£à¸§à¸¡à¸£à¸²à¸¢à¹„à¸”à¹‰ (Finance View)</small>
        <h2 id="total-revenue">à¸¿ 0.00</h2>
    </div>

    <button id="addBtn" class="btn-main hidden" onclick="openEditor(null)" style="margin-bottom:20px; background:var(--green);">+ ADD NEW PROPERTY</button>
    <div id="list-container"></div>
</div>

<script>
    const api = "https://script.google.com/macros/s/AKfycbxUduvVQ2oDjgJT3HJlGDzpbEav1_orj-G2UalilY27QoRtSgNOHPFdw7-NNYPdakA8/exec";
    let user = null;

    async function handleLogin() {
        const pin = document.getElementById('pinInput').value;
        const res = await fetch(`${api}?action=universalLogin&key=${pin}`).then(r => r.json());
        if (res.success) {
            user = res;
            localStorage.setItem('smart_user', JSON.stringify(res));
            renderUI();
        } else { alert("Invalid PIN"); }
    }

    function renderUI() {
        user = user || JSON.parse(localStorage.getItem('smart_user'));
        if (!user) return;

        document.getElementById('login-box').classList.add('hidden');
        document.getElementById('main-dashboard').classList.remove('hidden');
        document.getElementById('logout-btn').classList.remove('hidden');
        document.getElementById('user-display').innerHTML = `${user.name} <span class="badge role-${user.role}">${user.role}</span>`;

        // ðŸ›¡ï¸ à¸à¸Žà¸à¸²à¸£à¸¡à¸­à¸‡à¹€à¸«à¹‡à¸™à¸›à¸¸à¹ˆà¸¡ (UI Permissions)
        if (['SUPER_ADMIN', 'PROJECT_ADMIN', 'AGENT'].includes(user.role)) {
            document.getElementById('addBtn').classList.remove('hidden');
        }
        if (['SUPER_ADMIN', 'FINANCE'].includes(user.role)) {
            document.getElementById('finance-summary').classList.remove('hidden');
        }

        fetchData();
    }

    async function fetchData() {
        const container = document.getElementById('list-container');
        container.innerHTML = "Loading properties...";
        // à¸ªà¹ˆà¸‡ Role à¹à¸¥à¸° Project à¹„à¸›à¸à¸£à¸­à¸‡à¸—à¸µà¹ˆà¸à¸±à¹ˆà¸‡ Server
        const data = await fetch(`${api}?role=${user.role}&project=${user.project}`).then(r => r.json());
        
        container.innerHTML = "";
        let totalVal = 0;
        data.forEach(item => {
            totalVal += Number(item.Price) || 0;
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div>
                                <div style="font-weight:600; color:var(--primary);">${item.HP_ID} | ${item.ID}</div>
                                <div style="font-size:0.8rem; color:#888;">${item.Project_Name || 'No Project Name'}</div>
                              </div>
                              <div onclick="alert('Viewing: ${item.HP_ID}')"><i class="fas fa-chevron-right"></i></div>`;
            container.appendChild(card);
        });
        
        // à¸„à¸³à¸™à¸§à¸“à¸¢à¸­à¸” 1.5% à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¹ˆà¸²à¸¢à¸šà¸±à¸à¸Šà¸µ
        if (user.role === 'FINANCE' || user.role === 'SUPER_ADMIN') {
            document.getElementById('total-revenue').innerText = `à¸¿ ${(totalVal * 0.015).toLocaleString()} (Fee 1.5%)`;
        }
    }

    function logout() { localStorage.clear(); location.reload(); }
    window.onload = () => { if(localStorage.getItem('smart_user')) renderUI(); };
</script>
</body>
</html>
