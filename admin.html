<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Management - SMART SYSTEM V31.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #1a5276; --bg: #f4f7f6; --white: #ffffff; --green: #27ae60; --text: #2c3e50; --gold: #f1c40f; --red: #e74c3c; --border: #ddd; --loader-bg: #9CBCE3; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); -webkit-tap-highlight-color: transparent; }

        /* üé® Loader */
        #loader-container { position: fixed; inset: 0; background: var(--loader-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease; }
        .emoji-group { display: flex; gap: 15px; margin-bottom: 25px; font-size: 60px; }
        .bounce { animation: bounce 0.6s infinite alternate; }
        @keyframes bounce { from { transform: translateY(0); } to { transform: translateY(-20px); } }
        .loader-text { color: white; font-weight: 900; font-size: 1.6rem; letter-spacing: 1px; text-transform: uppercase; text-align: center; }

        /* üö© Header */
        header { background: #fff; padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-left { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .brand-name { font-weight: 500; font-size: 0.85rem; color: var(--primary); text-transform: uppercase; border-left: 1.5px solid #eee; padding-left: 10px; }
        .logout-btn { color: var(--red); font-size: 0.8rem; font-weight: 600; cursor: pointer; }

        /* üîê Login Box */
        .login-container { display: flex; align-items: center; justify-content: center; padding: 40px 20px; min-height: 80vh; }
        .login-card { background: #fff; width: 100%; max-width: 400px; padding: 40px 30px; border-radius: 35px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); text-align: center; }
        .input-field { width: 100%; padding: 15px; border-radius: 50px; border: 1.5px solid var(--border); box-sizing: border-box; font-family: 'Kanit'; text-align: center; margin-bottom: 20px; outline: none; }
        .btn-primary { width: 100%; padding: 15px; border-radius: 50px; border: none; background: var(--primary); color: white; font-family: 'Kanit'; font-weight: 600; cursor: pointer; box-shadow: 0 8px 20px rgba(26,82,118,0.2); }

        /* üìä Dashboard */
        #dashboard-section { display: none; padding: 20px 15px 100px; max-width: 800px; margin: 0 auto; }
        .property-item { background: #fff; border-radius: 20px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; border: 1px solid #f0f0f0; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .add-new-btn { background: var(--green); color: white; padding: 12px 25px; border-radius: 50px; text-decoration: none; font-size: 0.9rem; font-weight: 600; display: inline-flex; align-items: center; gap: 10px; margin-bottom: 20px; cursor: pointer; }

        /* üìù Form Section */
        #form-section { display: none; padding: 20px 15px 120px; max-width: 600px; margin: 0 auto; }
        .form-card { background: #fff; border-radius: 30px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        .label { font-size: 0.75rem; color: #888; margin-bottom: 5px; display: block; font-weight: 600; text-transform: uppercase; }
        .form-input { width: 100%; padding: 12px 15px; border-radius: 12px; border: 1.5px solid #eee; box-sizing: border-box; font-family: 'Kanit'; outline: none; font-size: 0.95rem; background: #fff; color: var(--text); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        /* üì∏ Image Upload Styling */
        .image-preview-box { width: 100%; height: 200px; background: #f8f9fa; border: 2px dashed #ddd; border-radius: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 10px; position: relative; }
        .image-preview-box img { width: 100%; height: 100%; object-fit: cover; }
        .upload-trigger { background: var(--primary); color: white; padding: 10px 20px; border-radius: 50px; font-size: 0.8rem; cursor: pointer; display: inline-block; margin-top: 5px; }
        #imageFile { display: none; }

        .footer-action { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; padding: 15px 20px 25px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); display: flex; gap: 10px; z-index: 2000; border-radius: 25px 25px 0 0; max-width: 600px; margin: 0 auto; }
        .btn-save { flex: 2; background: var(--green); color: white; padding: 15px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; cursor: pointer; }
        .btn-cancel { flex: 1; background: #eee; color: #666; padding: 15px; border-radius: 15px; border: none; font-family: 'Kanit'; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader-container">
    <div class="emoji-group"><span class="bounce">üêö</span><span class="bounce" style="animation-delay:0.2s">üåä</span><span class="bounce" style="animation-delay:0.4s">üå¥</span></div>
    <div class="loader-text">SMART PROPERTIES SYSTEM</div>
</div>

<header>
    <div class="header-left" onclick="goHome()">
        <i class="fas fa-chevron-left" style="color:var(--primary);"></i>
        <div class="brand-name">ADMIN PORTAL</div>
    </div>
    <div id="header-logout" class="logout-btn" style="display:none;" onclick="logout()">LOGOUT</div>
</header>

<div id="login-section" class="login-container">
    <div class="login-card">
        <div style="font-size:3rem; color:var(--primary); margin-bottom:20px;"><i class="fas fa-user-lock"></i></div>
        <h2>Agent Login</h2>
        <input type="password" id="accessKey" class="input-field" placeholder="Access Key">
        <button id="loginBtn" class="btn-primary" onclick="handleLogin()">ENTER SYSTEM</button>
    </div>
</div>

<div id="dashboard-section">
    <div style="margin-bottom:20px;"><h2 id="agent-welcome" style="margin:0;">‡∏Ñ‡∏∏‡∏ì Agent</h2></div>
    <div class="add-new-btn" onclick="openEditor(null)"><i class="fas fa-plus"></i> ADD NEW PROPERTY</div>
    <div id="property-list"></div>
</div>

<div id="form-section">
    <div class="form-card">
        <h2 id="form-title" style="margin-top:0; color:var(--primary);">Property Editor</h2>
        
        <div class="form-group">
            <label class="label">Thumbnail Image (‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏Å)</label>
            <div class="image-preview-box" id="preview-container">
                <span id="preview-text" style="color:#aaa; font-size:0.8rem;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</span>
                <img id="imagePreview" style="display:none;">
            </div>
            <label for="imageFile" class="upload-trigger"><i class="fas fa-camera"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà</label>
            <input type="file" id="imageFile" accept="image/*" onchange="previewFile()">
            <input type="hidden" id="Thumbnail"> </div>

        <div class="form-row">
            <div class="form-group"><label class="label">HP_ID</label><input type="text" id="HP_ID" class="form-input" readonly style="background:#f9f9f9;"></div>
            <div class="form-group"><label class="label">Plot/ID</label><input type="text" id="ID" class="form-input"></div>
        </div>
        
        <div class="form-group">
            <label class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
            <select id="Status" class="form-input">
                <option value="Available">Available</option><option value="Pending">Pending</option><option value="Sold">Sold</option>
            </select>
        </div>

        <div class="form-group"><label class="label">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ / ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label><input type="text" id="Project_Name" class="form-input"></div>
        
        <div class="form-row">
            <div class="form-group"><label class="label">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)</label><input type="number" id="Price" class="form-input"></div>
            <div class="form-group"><label class="label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏° (%)</label><input type="number" id="Commission_Pct" class="form-input"></div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label class="label">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
                <select id="District" class="form-input" onchange="updateSubDistricts()">
                    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ --</option>
                    <option value="‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô">‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô</option><option value="‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ">‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ</option><option value="‡∏ä‡∏∞‡∏≠‡∏≥">‡∏ä‡∏∞‡∏≠‡∏≥</option>
                </select>
            </div>
            <div class="form-group">
                <label class="label">‡∏ï‡∏≥‡∏ö‡∏•</label>
                <select id="SubDistrict" class="form-input"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option></select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group"><label class="label">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô</label><input type="number" id="Bedrooms" class="form-input"></div>
            <div class="form-group"><label class="label">‡∏´‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≥</label><input type="number" id="Bathrooms" class="form-input"></div>
        </div>

        <div class="form-group"><label class="label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><textarea id="Description" class="form-input" rows="3"></textarea></div>
    </div>
    
    <div class="footer-action">
        <button class="btn-cancel" onclick="showDashboard()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="saveBtn" class="btn-save" onclick="processSave()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </div>
</div>

<script>
    const api = "https://script.google.com/macros/s/AKfycbwUqp_vaFNgUdyARh5WG-S3iRm_x1C4EX0tL8aw12nhKpvYVn3I7SwWmi5s-doiYGYh/exec";
    const locationData = { "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô": ["‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô", "‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Å", "‡∏´‡∏¥‡∏ô‡πÄ‡∏´‡∏•‡πá‡∏Å‡πÑ‡∏ü", "‡∏ó‡∏±‡∏ö‡πÉ‡∏ï‡πâ", "‡∏´‡πâ‡∏ß‡∏¢‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÉ‡∏´‡∏ç‡πà", "‡∏ö‡∏∂‡∏á‡∏ô‡∏Ñ‡∏£", "‡∏´‡∏ô‡∏≠‡∏á‡∏û‡∏•‡∏±‡∏ö"], "‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ": ["‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏Ç‡∏≤‡∏ô‡πâ‡∏≠‡∏¢", "‡∏õ‡∏≤‡∏Å‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏≤‡∏ì", "‡∏´‡∏ô‡∏≠‡∏á‡∏ï‡∏≤‡πÅ‡∏ï‡πâ‡∏°", "‡∏ß‡∏±‡∏á‡∏Å‡πå‡∏û‡∏á", "‡πÄ‡∏Ç‡∏≤‡∏à‡πâ‡∏≤‡∏ß"], "‡∏ä‡∏∞‡∏≠‡∏≥": ["‡∏ä‡∏∞‡∏≠‡∏≥", "‡πÄ‡∏Ç‡∏≤‡πÉ‡∏´‡∏ç‡πà", "‡∏î‡∏≠‡∏ô‡∏Ç‡∏∏‡∏ô‡∏´‡πâ‡∏ß‡∏¢", "‡∏ô‡∏≤‡∏¢‡∏≤‡∏á", "‡∏ö‡∏≤‡∏á‡πÄ‡∏Å‡πà‡∏≤", "‡πÑ‡∏£‡πà‡πÉ‡∏´‡∏°‡πà‡∏û‡∏±‡∏í‡∏ô‡∏≤"] };
    let allData = [], imageRawData = null;

    window.onload = () => {
        const token = localStorage.getItem('admin_token');
        if (token) { showDashboard(localStorage.getItem('agent_name')); }
        setTimeout(() => { document.getElementById('loader-container').style.display = 'none'; }, 800);
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    function previewFile() {
        const preview = document.getElementById('imagePreview');
        const text = document.getElementById('preview-text');
        const file = document.getElementById('imageFile').files[0];
        const reader = new FileReader();

        reader.onloadend = function() {
            preview.src = reader.result;
            preview.style.display = "block";
            text.style.display = "none";
            imageRawData = reader.result; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Base64 ‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡∏´‡∏•‡∏±‡∏á‡∏ö‡πâ‡∏≤‡∏ô
        }

        if (file) { reader.readAsDataURL(file); }
    }

    async function handleLogin() {
        const key = document.getElementById('accessKey').value;
        const result = await fetch(`${api}?action=universalLogin&key=${key}`).then(r => r.json());
        if (result.success) {
            localStorage.setItem('admin_token', key);
            localStorage.setItem('agent_name', result.name);
            showDashboard(result.name);
        } else { alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
    }

    async function showDashboard(name) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('form-section').style.display = 'none';
        document.getElementById('dashboard-section').style.display = 'block';
        document.getElementById('header-logout').style.display = 'block';
        document.getElementById('agent-welcome').innerText = `‡∏Ñ‡∏∏‡∏ì ${name}`;
        
        const list = document.getElementById('property-list');
        list.innerHTML = "<p style='text-align:center;'>Loading Properties...</p>";
        
        try {
            allData = await fetch(api).then(r => r.json());
            list.innerHTML = "";
            allData.filter(it => it.HP_ID).forEach(it => {
                const div = document.createElement('div');
                div.className = 'property-item';
                div.innerHTML = `<div><div style="font-weight:700;color:var(--primary)">${it.HP_ID} | ${it.ID}</div><div>${it.Project_Name}</div></div>
                                 <div style="cursor:pointer;color:var(--primary)" onclick='openEditor("${it.HP_ID}")'><i class='fas fa-edit fa-lg'></i></div>`;
                list.appendChild(div);
            });
        } catch(e) { list.innerHTML = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"; }
    }

    function openEditor(hpId) {
        document.getElementById('dashboard-section').style.display = 'none';
        document.getElementById('form-section').style.display = 'block';
        imageRawData = null; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πà‡∏≤
        
        const item = hpId ? allData.find(x => x.HP_ID === hpId) : null;
        document.getElementById('form-title').innerText = item ? `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${hpId}` : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà";
        
        document.getElementById('HP_ID').value = item ? item.HP_ID : `HP-${Date.now().toString().slice(-4)}`;
        document.getElementById('ID').value = item ? item.ID : "";
        document.getElementById('Project_Name').value = item ? item.Project_Name : "";
        document.getElementById('Price').value = item ? item.Price : "";
        document.getElementById('Status').value = item ? item.Status : "Available";
        document.getElementById('Thumbnail').value = item ? item.Thumbnail : "";
        document.getElementById('Description').value = item ? item.Description : "";
        document.getElementById('Commission_Pct').value = item ? item['Commission (%)'] : 3;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û Preview
        const preview = document.getElementById('imagePreview');
        const text = document.getElementById('preview-text');
        if (item && item.Thumbnail) {
            preview.src = item.Thumbnail;
            preview.style.display = "block";
            text.style.display = "none";
        } else {
            preview.style.display = "none";
            text.style.display = "block";
        }

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•
        const distSelect = document.getElementById('District');
        distSelect.value = item ? item.District : "";
        updateSubDistricts(item ? item.SubDistrict : "");
    }

    function updateSubDistricts(selectedSub = "") {
        const dist = document.getElementById('District').value;
        const subSelect = document.getElementById('SubDistrict');
        subSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡∏ö‡∏• --</option>';
        if (locationData[dist]) {
            locationData[dist].forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.innerText = s;
                if (s === selectedSub) opt.selected = true;
                subSelect.appendChild(opt);
            });
        }
    }

    async function processSave() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true; btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
        
        const payload = {
            HP_ID: document.getElementById('HP_ID').value,
            ID: document.getElementById('ID').value,
            Project_Name: document.getElementById('Project_Name').value,
            Price: document.getElementById('Price').value,
            "Commission (%)": document.getElementById('Commission_Pct').value,
            District: document.getElementById('District').value,
            SubDistrict: document.getElementById('SubDistrict').value,
            Bedrooms: document.getElementById('Bedrooms').value,
            Bathrooms: document.getElementById('Bathrooms').value,
            Status: document.getElementById('Status').value,
            Description: document.getElementById('Description').value,
            Thumbnail: document.getElementById('Thumbnail').value, // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏î‡∏¥‡∏°
            imageRaw: imageRawData // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö Base64
        };

        try {
            const res = await fetch(api, { method: 'POST', body: JSON.stringify(payload) }).then(r => r.json());
            if (res.success) { alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); showDashboard(); }
        } catch(e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î"); }
        btn.disabled = false; btn.innerText = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }

    function goHome() { 
        if (document.getElementById('form-section').style.display === 'block') { showDashboard(); } 
        else { location.href = 'index.html'; }
    }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
