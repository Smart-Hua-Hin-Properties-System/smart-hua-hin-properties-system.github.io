<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>HUAHIN.PROPERTIES | Listings</title>

  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root { --primary:#1a5276; --bg:#9CBCE3; --white:#fff; --green:#00d44b; --text:#2c3e50; --border:#eee; }
    html,body{font-family:'Kanit',sans-serif;background:var(--bg);margin:0;padding:0;overflow-x:hidden;width:100%}
    *{box-sizing:border-box}

    #loader-container{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;transition:.5s}
    .emoji-group{display:flex;gap:15px;margin-bottom:25px;font-size:60px}
    .bounce{animation:bounce .6s infinite alternate}
    @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-20px)}}

    header{background:#fff;padding:12px 15px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1000;box-shadow:0 2px 10px rgba(0,0,0,.1)}
    .header-left{display:flex;align-items:center;gap:8px;cursor:pointer;color:var(--primary)}
    .flag-list{display:flex;gap:5px}
    .flag-btn{border:none;background:none;padding:0;cursor:pointer}
    .flag-btn img{width:24px;height:16px;border-radius:2px}

    .filter-area{padding:15px;max-width:1200px;margin:0 auto}
    .filter-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;background:rgba(255,255,255,.9);padding:15px;border-radius:25px}
    @media(min-width:768px){.filter-grid{grid-template-columns:repeat(4,1fr)}}
    .select-box{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);font-family:'Kanit';color:var(--primary);font-size:.82rem}

    .property-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;padding:0 15px 40px;max-width:1200px;margin:0 auto}
    .card{background:var(--white);border-radius:40px;overflow:hidden;position:relative;box-shadow:0 15px 35px rgba(0,0,0,.1)}
    .badge{position:absolute;top:20px;left:20px;background:var(--green);color:#fff;padding:6px 18px;border-radius:50px;font-weight:500;font-size:.8rem;z-index:10}
    .card-img{width:100%;height:350px;object-fit:cover}
    .card-body{padding:18px 18px 22px}
    .btn-detail{display:block;width:90%;margin:0 auto 20px;padding:14px;background:var(--primary);color:white;text-align:center;border-radius:50px;text-decoration:none;font-weight:500}
    .muted{color:#888;font-size:.85rem}
  </style>
</head>

<body>
  <div id="loader-container">
    <div class="emoji-group">
      <span class="bounce" style="animation-delay:0s">üêö</span>
      <span class="bounce" style="animation-delay:0.2s">üåä</span>
      <span class="bounce" style="animation-delay:0.4s">üå¥</span>
    </div>
    <div style="color:white;font-weight:900;font-size:1.5rem;">SMART PROPERTIES</div>
  </div>

  <header>
    <div class="header-left">
      <i class="fas fa-bars fa-lg"></i> <span style="font-size:0.85rem;font-weight:500;margin-left:5px;">‡πÄ‡∏°‡∏ô‡∏π</span>
    </div>
    <div style="font-weight:900;color:var(--primary);font-size:0.9rem;">HUAHIN.PROPERTIES</div>
    <div class="flag-list">
      <button class="flag-btn" onclick="setLanguage('th')"><img src="https://flagcdn.com/w40/th.png"></button>
      <button class="flag-btn" onclick="setLanguage('en')"><img src="https://flagcdn.com/w40/us.png"></button>
    </div>
  </header>

  <div class="filter-area">
    <div class="filter-grid">
      <select class="select-box" id="distFilter" onchange="onDistrictChange()">
        <option value="">üìç ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>

      <select class="select-box" id="subDistFilter" onchange="applyFilters()">
        <option value="">üèòÔ∏è ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      </select>

      <select class="select-box" id="bedFilter" onchange="applyFilters()">
        <option value="">üõå ‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
        <option value="4">4</option><option value="5">5</option><option value="6">6</option>
        <option value="6.5">6+</option>
      </select>

      <select class="select-box" id="priceSort" onchange="applyFilters()">
        <option value="">üí∞ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏Ñ‡∏≤</option>
        <option value="low">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å</option>
        <option value="high">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢</option>
      </select>
    </div>
  </div>

  <div class="property-grid" id="grid"></div>

<script>
  // ‚úÖ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô endpoint ‡πÉ‡∏´‡∏°‡πà
  const api = "https://script.google.com/macros/s/AKfycbyS8rGtSnhVS8RdWje7icXZVCw5iBBJoWkEpOYm649OC6FOhnrVi87dD9GsJl_m_FVw/exec";

  let allData = [];
  let currentLang = localStorage.getItem('smartLang') || 'th';

  const i18n = {
    th: { view: "‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" },
    en: { view: "View Details" }
  };

  // normalize ‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡∏ï‡∏≥‡∏ö‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏°‡πâ‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ
  function norm(s) {
    return String(s || "")
      .trim()
      .toLowerCase()
      .replace(/\s+/g, "");
  }

  // ‡∏ó‡∏≥ label ‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏™‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
  const districtLabelMap = {
    "huahin": "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô",
    "hua hin": "‡∏´‡∏±‡∏ß‡∏´‡∏¥‡∏ô",
    "chaam": "‡∏ä‡∏∞‡∏≠‡∏≥",
    "cha-am": "‡∏ä‡∏∞‡∏≠‡∏≥",
    "pranburi": "‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ",
    "pran buri": "‡∏õ‡∏£‡∏≤‡∏ì‡∏ö‡∏∏‡∏£‡∏µ"
  };

  function prettyDistrictName(raw) {
    const k = String(raw || "").trim().toLowerCase();
    const key = k.replace(/\s+/g, "");
    return districtLabelMap[key] || raw || "";
  }

  function formatToH3(url) {
    if (!url || url.trim() === "") return "https://placehold.co/600x800";
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô lh3 ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
    if (url.includes("https://lh3.googleusercontent.com/d/")) return url;

    // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏™‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô drive link
    let fileId = "";
    try {
      if (url.includes("id=")) fileId = url.split("id=")[1].split("&")[0];
      else if (url.includes("/file/d/")) fileId = url.split("/file/d/")[1].split("/")[0];
    } catch(e) {}
    return fileId ? ("https://lh3.googleusercontent.com/d/" + fileId) : url;
  }

  async function init() {
    try {
      const res = await fetch(`${api}?action=listPublic`);
      const payload = await res.json();

      // payload ‡πÄ‡∏õ‡πá‡∏ô list ‡∏ï‡∏£‡∏á‡πÜ (‡∏ï‡∏≤‡∏° Apps Script)
      allData = Array.isArray(payload) ? payload : [];

      buildDistrictOptions();
      onDistrictChange(); // ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ï‡∏≥‡∏ö‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏° ‡πÅ‡∏•‡∏∞ render ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å

      setLanguage(currentLang);

      document.getElementById('loader-container').style.opacity = '0';
      setTimeout(() => document.getElementById('loader-container').style.display = 'none', 500);
    } catch (e) {
      document.getElementById('grid').innerHTML = "Error Connecting to Database";
    }
  }

  function setLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('smartLang', lang);
    applyFilters();
  }

  function buildDistrictOptions() {
    const distSel = document.getElementById('distFilter');

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà
    distSel.innerHTML = `<option value="">üìç ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

    const districts = [...new Set(allData.map(x => x.District).filter(Boolean))];

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
    districts.sort((a,b) => String(a).localeCompare(String(b), 'th'));

    districts.forEach(d => {
      const label = prettyDistrictName(d);
      distSel.innerHTML += `<option value="${escapeHtml(d)}">${escapeHtml(label)}</option>`;
    });
  }

  function onDistrictChange() {
    updateSubDistrictOptions();
    applyFilters();
  }

  function updateSubDistrictOptions() {
    const distSel = document.getElementById('distFilter');
    const subSel = document.getElementById('subDistFilter');
    const selectedDistrictRaw = distSel.value;

    subSel.innerHTML = `<option value="">üèòÔ∏è ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>`;

    if (!selectedDistrictRaw) return;

    // ‚úÖ ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏ö‡∏ö normalize ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©/‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏£‡∏£‡∏Ñ
    const selectedNorm = norm(selectedDistrictRaw);

    const subs = [...new Set(
      allData
        .filter(x => norm(x.District) === selectedNorm)
        .map(x => x.SubDistrict)
        .filter(Boolean)
    )].sort((a,b) => String(a).localeCompare(String(b), 'th'));

    subs.forEach(s => {
      subSel.innerHTML += `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`;
    });
  }

  function applyFilters() {
    let data = [...allData];

    const dist = document.getElementById('distFilter').value;
    const sub = document.getElementById('subDistFilter').value;
    const bed = document.getElementById('bedFilter').value;
    const sort = document.getElementById('priceSort').value;

    if (dist) {
      const dn = norm(dist);
      data = data.filter(x => norm(x.District) === dn);
    }
    if (sub) {
      const sn = norm(sub);
      data = data.filter(x => norm(x.SubDistrict) === sn);
    }
    if (bed) {
      if (bed === "6.5") data = data.filter(x => Number(x.Bedrooms) >= 6);
      else data = data.filter(x => Number(x.Bedrooms) >= Number(bed));
    }

    if (sort === "low") data.sort((a,b) => (Number(a.Price)||0) - (Number(b.Price)||0));
    if (sort === "high") data.sort((a,b) => (Number(b.Price)||0) - (Number(a.Price)||0));

    renderGrid(data);
  }

  function renderGrid(items) {
    const grid = document.getElementById('grid');
    grid.innerHTML = "";

    if (!items.length) {
      grid.innerHTML = `<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
      return;
    }

    items.forEach(it => {
      const img = formatToH3(it.Thumbnail);
      const price = Number(it.Price || 0).toLocaleString();

      grid.innerHTML += `
        <div class="card">
          <div class="badge">CODE: ${escapeHtml(it.ID || '')}</div>
          <img src="${img}" class="card-img" onerror="this.src='https://placehold.co/600x800'">
          <div class="card-body">
            <div style="font-size:0.8rem;color:#888;margin-bottom:6px;">${escapeHtml(it.Project_Name || 'HUAHIN')}</div>
            <div style="font-size:1.8rem;color:var(--primary);font-weight:600;margin-bottom:16px;">‡∏ø${price}</div>
            <a href="details.html?id=${encodeURIComponent(it.HP_ID)}" class="btn-detail">
              ${(i18n[currentLang] && i18n[currentLang].view) ? i18n[currentLang].view : "View Details"}
            </a>
          </div>
        </div>
      `;
    });
  }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  window.onload = init;
</script>
</body>
</html>
